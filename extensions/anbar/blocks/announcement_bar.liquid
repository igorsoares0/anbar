{% comment %}
Theme: Announcement Bar App Block
Description: Displays an announcement bar with customizable styling and content
{% endcomment %}

<style>
  .anbar-announcement-container {
    position: relative;
    width: 100%;
    z-index: 1000;
  }
  
  .anbar-container-top {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    z-index: 1000;
  }
  
  .anbar-container-bottom {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    z-index: 1000;
  }
  
  .anbar-container-cart {
    position: relative;
    z-index: 100;
  }
  
  .anbar-container-custom {
    position: relative;
    z-index: 100;
  }
  
  .anbar-announcement-bar {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 12px 16px;
    width: 100%;
    box-sizing: border-box;
    position: relative;
  }
  
  .anbar-content {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    flex: 1;
  }
  
  .anbar-text-group {
    display: flex;
    align-items: center;
    gap: 8px;
  }
  
  .anbar-announcement-bar:not(.anbar-continuous) .anbar-text-group {
    flex-direction: column;
    align-items: flex-start;
    gap: 4px;
  }
  
  .anbar-actions {
    display: flex;
    align-items: center;
    gap: 8px;
  }
  
  .anbar-title {
    font-weight: bold;
    margin: 0;
    word-wrap: break-word;
    overflow-wrap: break-word;
    hyphens: auto;
  }
  
  .anbar-subtitle {
    margin: 0;
    word-wrap: break-word;
    overflow-wrap: break-word;
    hyphens: auto;
  }
  
  .anbar-discount-code-container {
    display: inline-flex;
    align-items: center;
    border: 2px dashed;
    border-radius: 6px;
    padding: 6px 12px;
    gap: 8px;
    cursor: pointer;
    transition: background-color 0.2s ease;
  }

  .anbar-discount-code-container:hover {
    background-color: rgba(255, 255, 255, 0.1);
  }

  .anbar-discount-code {
    font-weight: bold;
    margin: 0;
    user-select: none;
  }

  .anbar-copy-text {
    font-size: 12px;
    opacity: 0.8;
    user-select: none;
  }
  
  .anbar-button {
    border: none;
    cursor: pointer;
    text-decoration: none;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    padding: 8px 16px;
    min-height: 36px;
    transition: opacity 0.2s ease;
    white-space: nowrap;
  }
  
  .anbar-button:hover {
    opacity: 0.8;
  }
  
  .anbar-close {
    cursor: pointer;
    font-size: 18px;
    line-height: 1;
    background: none;
    border: none;
    padding: 8px;
    margin: 0;
    min-width: 36px;
    min-height: 36px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: opacity 0.2s ease;
    border-radius: 4px;
  }
  
  .anbar-close:hover {
    opacity: 0.7;
    background-color: rgba(255, 255, 255, 0.1);
  }
  
  .anbar-clickable {
    cursor: pointer;
    text-decoration: none;
    color: inherit;
    background-color: inherit;
    border: inherit;
    border-radius: inherit;
    display: inherit;
    align-items: inherit;
    justify-content: inherit;
    padding: inherit;
    width: inherit;
    box-sizing: inherit;
    position: inherit;
  }
  
  .anbar-continuous {
    overflow: hidden;
    white-space: nowrap;
    position: relative;
  }
  
  .anbar-continuous .anbar-content {
    display: inline-block;
    white-space: nowrap;
    animation: anbar-marquee 15s linear infinite;
    padding-left: 100%;
  }
  
  @keyframes anbar-marquee {
    0% { transform: translate3d(0, 0, 0); }
    100% { transform: translate3d(-100%, 0, 0); }
  }
  
  .anbar-continuous:hover .anbar-content {
    animation-play-state: paused;
  }
  
  .anbar-multiple {
    position: relative;
  }
  
  .anbar-arrow {
    background: rgba(255, 255, 255, 0.2);
    border: none;
    color: inherit;
    cursor: pointer;
    padding: 8px;
    min-width: 36px;
    min-height: 36px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 4px;
    transition: background-color 0.2s ease;
    font-size: 16px;
  }
  
  .anbar-arrow:hover {
    background: rgba(255, 255, 255, 0.3);
  }
  
  /* Reduced Motion Support */
  @media (prefers-reduced-motion: reduce) {
    .anbar-continuous .anbar-content {
      animation: none !important;
    }
    
    .anbar-button, .anbar-close, .anbar-arrow {
      transition: none !important;
    }
  }
  
  /* Tablet Responsive */
  @media (max-width: 768px) {
    .anbar-announcement-bar {
      flex-direction: column;
      text-align: center;
      padding: 10px 16px;
      min-height: 60px;
    }
    
    .anbar-content {
      flex-direction: column;
      gap: 6px;
      margin-bottom: 10px;
    }
    
    .anbar-text-group {
      max-width: calc(100vw - 100px);
    }
    
    .anbar-title {
      font-size: clamp(14px, 4vw, 18px) !important;
    }
    
    .anbar-subtitle {
      font-size: clamp(12px, 3.5vw, 16px) !important;
    }
    
    .anbar-actions {
      justify-content: center;
      gap: 12px;
    }
    
    .anbar-button {
      padding: 12px 20px;
      min-height: 44px;
      font-size: 16px !important;
    }
    
    .anbar-close {
      min-width: 44px;
      min-height: 44px;
      font-size: 20px;
      padding: 12px;
    }
    
    .anbar-arrow {
      min-width: 44px;
      min-height: 44px;
      padding: 12px;
      font-size: 18px;
    }
    
    .anbar-discount-code-container {
      padding: 10px 16px;
      font-size: 14px !important;
      margin: 4px 0;
    }
    
    .anbar-continuous .anbar-content {
      flex-direction: row;
      margin-bottom: 0;
      animation: anbar-marquee 18s linear infinite;
    }
  }
  
  /* Mobile Responsive */
  @media (max-width: 480px) {
    .anbar-announcement-bar {
      padding: 8px 12px;
      min-height: 56px;
    }
    
    .anbar-content {
      gap: 4px;
      margin-bottom: 8px;
    }
    
    .anbar-text-group {
      max-width: calc(100vw - 80px);
    }
    
    .anbar-title {
      font-size: clamp(13px, 3.5vw, 16px) !important;
      line-height: 1.3;
    }
    
    .anbar-subtitle {
      font-size: clamp(11px, 3vw, 14px) !important;
      line-height: 1.3;
    }
    
    .anbar-actions {
      gap: 8px;
      flex-wrap: wrap;
    }
    
    .anbar-button {
      padding: 10px 16px;
      min-height: 44px;
      font-size: 15px !important;
      flex: 1;
      min-width: 120px;
    }
    
    .anbar-close {
      min-width: 44px;
      min-height: 44px;
      font-size: 18px;
    }
    
    .anbar-arrow {
      min-width: 40px;
      min-height: 40px;
      padding: 10px;
    }
    
    .anbar-discount-code-container {
      padding: 8px 12px;
      font-size: 13px !important;
      word-break: break-all;
      max-width: 100%;
    }
    
    .anbar-continuous .anbar-content {
      animation: anbar-marquee 20s linear infinite;
    }
  }
  
  /* Very Small Screens */
  @media (max-width: 320px) {
    .anbar-announcement-bar {
      padding: 6px 8px;
    }
    
    .anbar-text-group {
      max-width: calc(100vw - 60px);
    }
    
    .anbar-button {
      padding: 8px 12px;
      font-size: 14px !important;
      min-width: 100px;
    }
    
    .anbar-actions {
      gap: 6px;
    }
  }
</style>

{%- assign announcement_id = block.settings.announcement_id -%}
{%- if announcement_id != blank -%}
  {%- assign announcement_bars = shop.metafields.anbar.bars.value -%}
  {%- if announcement_bars -%}
    {%- for bar in announcement_bars -%}
      {%- if bar.id == announcement_id and bar.isActive and bar.isPublished -%}
        {%- assign show_bar = false -%}
        
        {%- case bar.displayLocation -%}
          {%- when 'all_pages' -%}
            {%- assign show_bar = true -%}
          {%- when 'homepage' -%}
            {%- if template.name == 'index' -%}
              {%- assign show_bar = true -%}
            {%- endif -%}
          {%- when 'cart' -%}
            {%- if template.name == 'cart' -%}
              {%- assign show_bar = true -%}
            {%- endif -%}
          {%- when 'all_collections' -%}
            {%- if template.name == 'collection' -%}
              {%- assign show_bar = true -%}
            {%- endif -%}
          {%- when 'products' -%}
            {%- if template.name == 'product' -%}
              {%- assign show_bar = true -%}
            {%- endif -%}
          {%- when 'specific_products' -%}
            {%- if template.name == 'product' -%}
              {%- if bar.targetProducts -%}
                {% comment %} Debug: Show what we're comparing {% endcomment %}
                <!-- DEBUG APPBLOCK: Current product ID: {{ product.id }} -->
                <!-- DEBUG APPBLOCK: Target products: {{ bar.targetProducts | join: ', ' }} -->
                {%- for product_id in bar.targetProducts -%}
                  {%- assign current_product_id = product.id | plus: 0 -%}
                  {%- assign target_product_id = product_id | plus: 0 -%}
                  <!-- DEBUG APPBLOCK: Comparing {{ current_product_id }} with {{ target_product_id }} -->
                  {%- if current_product_id == target_product_id -%}
                    {%- assign show_bar = true -%}
                    <!-- DEBUG APPBLOCK: MATCH FOUND! -->
                    {%- break -%}
                  {%- endif -%}
                {%- endfor -%}
              {%- endif -%}
            {%- endif -%}
          {%- when 'collections' -%}
            {%- if template.name == 'product' and bar.targetCollections -%}
              {%- for collection_id in bar.targetCollections -%}
                {%- for product_collection in product.collections -%}
                  {%- if product_collection.id == collection_id -%}
                    {%- assign show_bar = true -%}
                    {%- break -%}
                  {%- endif -%}
                {%- endfor -%}
                {%- if show_bar -%}
                  {%- break -%}
                {%- endif -%}
              {%- endfor -%}
            {%- endif -%}
          {%- when 'specific_collections' -%}
            {%- if template.name == 'collection' and bar.targetCollections -%}
              {%- for collection_id in bar.targetCollections -%}
                {%- if collection.id == collection_id -%}
                  {%- assign show_bar = true -%}
                  {%- break -%}
                {%- endif -%}
              {%- endfor -%}
            {%- endif -%}
          {%- when 'custom' -%}
            {%- assign show_bar = true -%}
        {%- endcase -%}
        
        {%- if show_bar -%}
          {%- assign position_class = '' -%}
          {%- if bar.displayLocation == 'cart' or bar.displayLocation == 'custom' -%}
            {%- assign position_class = bar.displayLocation -%}
          {%- else -%}
            {%- assign position_class = bar.position -%}
          {%- endif -%}
          
          <div class="anbar-announcement-container anbar-container-{{ position_class }}" 
               id="anbar-{{ bar.id }}" 
               data-position="{{ bar.position }}">
            
            {%- assign wrapper_element = 'div' -%}
            {%- assign wrapper_attrs = '' -%}
            
            {%- if bar.callToAction == 'full_bar' and bar.link != blank -%}
              {%- assign wrapper_element = 'a' -%}
              {%- assign wrapper_attrs = 'href="' | append: bar.link | append: '" class="anbar-clickable"' -%}
            {%- endif -%}
            
            <{{ wrapper_element }} 
              {% if wrapper_attrs != blank %}{{ wrapper_attrs }}{% endif %}
              class="anbar-announcement-bar{% if bar.announcementType == 'continuous' %} anbar-continuous{% elsif bar.announcementType == 'multiple' %} anbar-multiple{% endif %}"
              style="
                background-color: {{ bar.backgroundColor }};
                border-radius: {{ bar.borderRadius }}px;
                border: {{ bar.borderWidth }}px solid {{ bar.borderColor }};
                font-family: {{ bar.fontFamily }};
              ">
              
              <div class="anbar-content">
                <div class="anbar-text-group">
                  {%- if bar.title != blank -%}
                    <span class="anbar-title" style="
                      font-size: {{ bar.titleSize }}px;
                      color: {{ bar.titleColor }};
                    ">{{ bar.title }}</span>
                  {%- endif -%}
                  
                  {%- if bar.subtitle != blank -%}
                    <span class="anbar-subtitle" style="
                      font-size: {{ bar.subtitleSize }}px;
                      color: {{ bar.subtitleColor }};
                    ">{{ bar.subtitle }}</span>
                  {%- endif -%}
                </div>
                
                {%- if bar.discountCode != blank -%}
                  <div class="anbar-discount-code-container" 
                    onclick="navigator.clipboard.writeText('{{ bar.discountCode }}').then(() => { 
                      const codeText = this.querySelector('.anbar-discount-code');
                      const originalText = codeText.textContent; 
                      codeText.textContent = 'Copied!'; 
                      setTimeout(() => { codeText.textContent = originalText; }, 1500); 
                    }).catch(() => { 
                      const codeText = this.querySelector('.anbar-discount-code');
                      const originalText = codeText.textContent; 
                      codeText.textContent = 'Click to copy'; 
                      setTimeout(() => { codeText.textContent = originalText; }, 1500); 
                    });"
                    style="
                      border-color: {{ bar.discountCodeColor }};
                      color: {{ bar.discountCodeColor }};
                    ">
                    <span class="anbar-discount-code" style="font-size: {{ bar.titleSize }}px;">{{ bar.discountCode }}</span>
                  </div>
                {%- endif -%}
              </div>
              
              <div class="anbar-actions">
                {%- if bar.announcementType == 'multiple' -%}
                  <button class="anbar-arrow" onclick="anbarPrevious('{{ bar.id }}')" style="color: {{ bar.titleColor }};">‹</button>
                  <button class="anbar-arrow" onclick="anbarNext('{{ bar.id }}')" style="color: {{ bar.titleColor }};">›</button>
                {%- endif -%}
                
                {%- if bar.callToAction == 'button' and bar.link != blank -%}
                  <a href="{{ bar.link }}" 
                     class="anbar-button"
                     style="
                       background-color: {{ bar.buttonColor }};
                       color: {{ bar.buttonTextColor }};
                       font-size: {{ bar.buttonTextSize }}px;
                       border-radius: {{ bar.buttonBorderRadius }}px;
                     ">{{ bar.buttonText | default: "Shop Now" }}</a>
                {%- endif -%}
                
                {%- if bar.showCloseIcon -%}
                  <button class="anbar-close" 
                          onclick="anbarClose('{{ bar.id }}')"
                          style="color: {{ bar.titleColor }};">×</button>
                {%- endif -%}
              </div>
            </{{ wrapper_element }}>
          </div>
          
          <script>
            function anbarClose(barId) {
              const bar = document.getElementById('anbar-' + barId);
              if (bar) {
                bar.style.display = 'none';
                sessionStorage.setItem('anbar-closed-' + barId, 'true');
              }
            }
            
            function anbarNext(barId) {
              // Implement multiple announcement navigation
              console.log('Next announcement for bar:', barId);
            }
            
            function anbarPrevious(barId) {
              // Implement multiple announcement navigation
              console.log('Previous announcement for bar:', barId);
            }
            
            // Check if bar was previously closed in this session
            document.addEventListener('DOMContentLoaded', function() {
              const barId = '{{ bar.id }}';
              if (sessionStorage.getItem('anbar-closed-' + barId) === 'true') {
                const bar = document.getElementById('anbar-' + barId);
                if (bar) {
                  bar.style.display = 'none';
                }
              }
              
              // Adjust body padding for fixed positioned bars
              function adjustBodyPadding() {
                const topBars = document.querySelectorAll('.anbar-container-top');
                const bottomBars = document.querySelectorAll('.anbar-container-bottom');
                
                let topHeight = 0;
                let bottomHeight = 0;
                
                topBars.forEach(bar => {
                  if (bar.style.display !== 'none') {
                    topHeight += bar.offsetHeight;
                  }
                });
                
                bottomBars.forEach(bar => {
                  if (bar.style.display !== 'none') {
                    bottomHeight += bar.offsetHeight;
                  }
                });
                
                if (topHeight > 0) {
                  document.body.style.paddingTop = topHeight + 'px';
                }
                
                if (bottomHeight > 0) {
                  document.body.style.paddingBottom = bottomHeight + 'px';
                }
              }
              
              // Initial adjustment
              adjustBodyPadding();
              
              // Re-adjust when window resizes
              window.addEventListener('resize', adjustBodyPadding);
            });
          </script>
        {%- endif -%}
        {%- break -%}
      {%- endif -%}
    {%- endfor -%}
  {%- endif -%}
{%- endif -%}

{% schema %}
{
  "name": "Announcement Bar (Custom)",
  "target": "section",
  "settings": [
    {
      "type": "text",
      "id": "announcement_id",
      "label": "Announcement Bar ID",
      "info": "Enter the unique ID of the announcement bar you want to display"
    }
  ]
}
{% endschema %}